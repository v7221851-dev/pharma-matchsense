import pandas as pd
import os

# --- –ù–ê–°–¢–†–û–ô–ö–ò –§–ê–ô–õ–û–í ---
# –¢–µ–ø–µ—Ä—å –ø—É—Ç—å –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–ø–∞–ø–∫—É 'new_purchases'
INPUT_FILENAME = 'new_purchases/new_purchase.xlsx'    
OUTPUT_FILENAME = 'purchase_input.csv'     

# --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–Ø –ö–û–õ–û–ù–û–ö ---
# –°–ø–∏—Å–æ–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
RENAME_MAP = {
    # –ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
    'item_name_raw': ['–ù–∞–∑–≤–∞–Ω–∏—è', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–¢–æ–≤–∞—Ä'],
    # –ö–æ–ª–æ–Ω–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    'quantity': ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–ö–æ–ª-–≤–æ', '–ö–æ–ª–≤–æ', '–û–±—ä–µ–º']
}

# --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò ---

try:
    # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ (pharma_project)
    script_dir = os.path.dirname(os.path.abspath(__file__))
    
    # 2. –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –≤—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É
    # path: /Users/.../pharma_project/new_purchases/new_purchase.xlsx
    input_path = os.path.join(script_dir, INPUT_FILENAME)
    
    # 3. –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–ª—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (—Å–æ—Ö—Ä–∞–Ω–∏–º —Ä—è–¥–æ–º —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º)
    output_path = os.path.join(script_dir, OUTPUT_FILENAME)

    print(f"üìÅ –¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: {script_dir}")
    print(f"üîç –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ Excel: '{input_path}'...")
    
    # 4. –ß–¢–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º pd.read_excel –¥–ª—è —á—Ç–µ–Ω–∏—è –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ .xlsx —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ (header=0)
    df = pd.read_excel(input_path, header=0, sheet_name=0)
    
    # 5. –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï –ö–û–õ–û–ù–û–ö
    current_columns_to_rename = {}
    
    # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –Ω—É–∂–Ω—ã–º –Ω–∞–º –Ω–æ–≤—ã–º –∏–º–µ–Ω–∞–º –∏ –∏—Ö —Å–∏–Ω–æ–Ω–∏–º–∞–º
    for new_name, synonyms in RENAME_MAP.items():
        for synonym in synonyms:
            # –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Ç–µ–∫—É—â–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤)
            # –í–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ –µ—Å—Ç—å –¥–≤–∞ –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–∞, –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω –ø–µ—Ä–≤—ã–π –ø–æ–ø–∞–≤—à–∏–π—Å—è
            matching_col = next((
                col for col in df.columns if str(col).strip().lower() == synonym.lower()
            ), None)
            
            if matching_col:
                current_columns_to_rename[matching_col] = new_name
                break # –ù–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –Ω—É–∂–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
    if current_columns_to_rename:
        df.rename(columns=current_columns_to_rename, inplace=True)
        print(f"‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã –∫–æ–ª–æ–Ω–∫–∏: {current_columns_to_rename}")
    else:
        print("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Å–∏–Ω–æ–Ω–∏–º–∞–º.")

    # 6. –°–û–•–†–ê–ù–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ CSV —Å –Ω–æ–≤—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ (header=True)
    df.to_csv(output_path, sep=';', index=False, header=True, encoding='utf-8-sig')
    
    print(f"‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫: {output_path}")
    print("–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç 'matching_script.py'!")

except FileNotFoundError:
    print(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª '{input_path}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    print(f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ '{os.path.join(script_dir, 'new_purchases')}' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç –≤–Ω—É—Ç—Ä–∏ –Ω–µ–µ.")
except Exception as e:
    print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: {e}")